# Phase 4: V5.3 Engine Upgrade — State Normalization + Park Factor

**Date:** 2026-01-29 23:30
**Phase:** 4 (Engine Upgrade to KBO V5.3 Parity)

## Summary

Upgraded the MLB ELO engine from simplified formula (`delta = K * delta_run_exp`) to full KBO V5.3 parity with **state normalization** and **park factor adjustment**.

## Changes

### New Files
| File | Description |
|------|-------------|
| `data/mlb_park_factors.csv` | 30 MLB team park factors (100-scale) |
| `data/mlb_re24_baseline.csv` | 24 base-out state RE24 baselines (derived from 182K PAs) |
| `scripts/derive_re24_baseline.py` | One-time script to compute state baselines from Supabase |
| `src/engine/re24_baseline.py` | RE24Baseline class (state normalization) |
| `src/engine/park_factor.py` | ParkFactor class (venue adjustment) |
| `tests/test_engine_v53_upgrade.py` | 24 tests for upgrade features |

### Modified Files
| File | Change |
|------|--------|
| `src/engine/elo_config.py` | Added `ADJUSTMENT_SCALE = 0.1` |
| `src/engine/elo_calculator.py` | Added state/park/error params to `process_plate_appearance` |
| `src/engine/elo_batch.py` | Passes state + home_team + result_type to calculator |
| `scripts/run_elo.py` | Loads RE24 baseline + park factor; fetches extra PA columns |

## V5.3 Formula (Upgraded)

```
adjusted_rv  = delta_run_exp - park_adjustment
rv_diff      = adjusted_rv - mean_rv[state]
batter_delta = K * rv_diff
pitcher_delta = -K * rv_diff

where:
  park_adjustment = (park_factor - 1.0) * 0.1
  mean_rv[state]  = average delta_run_exp for that base-out state
```

### Three New Features
1. **State Normalization** — subtract mean delta_run_exp per base-out state (24 states, 0-23)
2. **Park Factor** — adjust for venue scoring environment (28 stadiums + 2 default)
3. **Field Error Handling** — zero out favorable deltas on errors (result_type = 'E')

## Before / After Comparison

| Metric | Before (Phase 2) | After (Phase 4) | Change |
|--------|------------------|------------------|--------|
| Mean ELO | 1500.0 | 1500.0 | 0 |
| Std Dev | 119.6 | 111.7 | -7.9 |
| Min ELO | 993.9 | 1129.8 | +135.9 |
| Max ELO | 2403.6 | 2343.3 | -60.3 |
| Net delta | +0.00 | -0.00 | Zero-Sum |
| Players | 1,469 | 1,469 | 0 |
| PAs | 183,092 | 183,092 | 0 |
| OHLC | 69,125 | 69,125 | 0 |

**Observation:** State normalization + park factor compresses the ELO distribution (Std 119.6 → 111.7). Systematic biases from lineup position and venue are now removed, producing fairer ratings.

## RE24 Baseline Stats

- 24 base-out states derived from 182,484 valid PAs
- Mean RV range: -0.001633 (Empty 0Out) to +0.038399 (2B3B 1Out)
- Impact: ~±3 ELO per 250 PAs

## Park Factor Impact

- Highest: COL (Coors Field) = 1.13 → adjustment = +0.013/PA
- Lowest: SEA (T-Mobile Park) = 0.91 → adjustment = -0.009/PA
- Coors Field impact: ~40 ELO over 250 home PAs

## Tests

- 72/72 tests pass (24 new + 48 existing)
- All existing tests remain backward-compatible
- New tests cover: baseline load, park factor, state encoding, integrated ELO, field error, zero-sum, backward compat

## Supabase Upload

- `player_elo`: 1,469 records (updated)
- `elo_pa_detail`: 183,092 records (updated)
- `daily_ohlc`: 69,125 records (re-uploaded)
